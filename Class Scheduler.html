<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Substitute Assignment Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        select[multiple] {
            height: 12rem;
        }
        @media (max-width: 768px) {
            select[multiple] {
                height: 8rem;
            }
        }
        /* A simplified print-specific stylesheet */
        @media print {
            .sub-report-container {
                page-break-before: always;
                padding: 1rem;
            }
            .sub-report-container:first-of-type {
                page-break-before: auto;
            }
            #main-controls {
                display: none;
            }
            #sub-reports-container {
                display: block !important;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <!-- Main Container -->
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-5xl mx-auto border-t-8 border-indigo-600">
        
        <!-- Main Controls -->
        <div id="main-controls">
            <!-- Header -->
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Substitute Assignment Manager</h1>
            <p class="text-center text-gray-500 mb-6">Select absent teachers and the day type to manage and print substitute assignments.</p>

            <!-- Absent Teacher, Day Type, and Day Selection -->
            <div class="space-y-6 mb-8">
                <div class="flex flex-col md:flex-row items-start gap-4">
                    <label for="absent-teacher-select" class="block text-gray-700 font-medium whitespace-nowrap pt-3">Select Absent Teacher(s):</label>
                    <select id="absent-teacher-select" multiple class="flex-grow w-full md:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                        <!-- Teachers will be populated by JavaScript -->
                    </select>
                </div>

                <div class="flex flex-col md:flex-row items-center gap-4">
                    <label for="day-type-select" class="block text-gray-700 font-medium whitespace-nowrap">Select Day Type:</label>
                    <select id="day-type-select" class="flex-grow w-full md:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                        <option value="" disabled selected>-- Choose day type --</option>
                        <option value="Normal">Normal Day</option>
                        <option value="2-Hour Delay">2-Hour Delay</option>
                        <option value="Half Day">Half Day</option>
                        <option value="Connections">Connections Day</option>
                    </select>
                </div>

                <div class="flex flex-col md:flex-row items-center gap-4">
                    <label for="day-select" class="block text-gray-700 font-medium whitespace-nowrap">Select A/B Day:</label>
                    <select id="day-select" class="flex-grow w-full md:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                        <option value="" disabled selected>-- Choose A/B Day --</option>
                        <option value="A-Day">A-Day</option>
                        <option value="B-Day">B-Day</option>
                    </select>
                </div>

                <div class="flex justify-center">
                    <button id="get-schedule-button" class="w-full md:w-1/2 p-3 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors duration-300 font-semibold shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        Get Combined Schedule
                    </button>
                </div>
            </div>

            <!-- Combined Schedule Display Area -->
            <div id="combined-schedule-area" class="mt-8 hidden">
                <h2 id="combined-schedule-title" class="text-xl font-semibold text-gray-700 mb-4"></h2>
                <div class="overflow-x-auto">
                    <table id="combined-schedule-table" class="min-w-full bg-white rounded-lg shadow-md">
                        <thead class="bg-gray-200 text-gray-700">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold">Teacher</th>
                                <th class="py-3 px-4 text-left font-semibold">Period</th>
                                <th class="py-3 px-4 text-left font-semibold">Class</th>
                                <th class="py-3 px-4 text-left font-semibold">Room</th>
                                <th class="py-3 px-4 text-left font-semibold">Status</th>
                                <th class="py-3 px-4 text-left font-semibold">Assign</th>
                            </tr>
                        </thead>
                        <tbody id="combined-schedule-body" class="text-gray-600">
                            <!-- Combined schedule rows will be injected here -->
                        </tbody>
                    </table>
                </div>
                <p id="no-classes-combined-message" class="text-gray-500 text-center mt-4 hidden">No classes found for the selected teachers on this day.</p>
                
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-6">
                    <button id="export-button" class="w-full md:w-1/2 p-3 text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors duration-300 font-semibold shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        Export to CSV
                    </button>
                    <button id="generate-reports-button" class="w-full md:w-1/2 p-3 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors duration-300 font-semibold shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        Generate Sub Reports
                    </button>
                </div>
            </div>
            
            <!-- Uncovered Classes Summary -->
            <div id="uncovered-summary-area" class="mt-8 p-6 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 rounded-lg shadow-inner hidden">
                <h3 class="text-lg font-bold">Uncovered Classes Summary</h3>
                <ul id="uncovered-list" class="mt-2 list-disc list-inside">
                    <!-- Uncovered classes will be listed here -->
                </ul>
                <p id="all-covered-message" class="mt-2 hidden">Great! All classes are currently covered. ðŸŽ‰</p>
            </div>
        </div>

        <!-- Container for the substitute reports (visible only after generation) -->
        <div id="sub-reports-container" class="hidden">
            <!-- Reports will be injected here -->
        </div>

    </div>

    <!-- JavaScript for the logic -->
    <script>
        // File content provided by the user.
        const csvContent = `Teacher,A1,B1,A2,B2,A3,B3,A4,B4
Andino,AP Calculus 207,,,AP Stats 207,LW 1 AP Calculus 207,LW 1 AP Stats 207,IM1/Lab 207,IM1/Lab 207
Angileri,AP/ECE Spanish 111,,AP/ECE Spanish 111,Spanish 4 111,,LW 2 AP/ECE Spanish 111,Spanish 3 111,Spanish 3 111
Bhavsar,English 9-1 203,English 9-1 203,,,LW 2 English 9-1 203,LW 2 English 9-1 203,English 10-H 203,English 10-H 203
Bogard,,,,,LW 1 FYS 209,,,
Bredy,EL Literacy 1 301,EL Literacy 1 301,,,,,,
Capeci,Reading 217B,,,,LW 2 IED 217B,LW 1 IED 217B,Push In IM1/Lab 207,Push In IM1/Lab 207
Carey ,,,,,LW 2 VHS MC,LW 2 VHS MC,,
Cole,,,Intro to Business 305,Intro to Business 305,LW 2 Entrepreneurship 311,LW 2 Entrepreneurship 311,Intro to Business 306,Intro to Business 306
Dalton,,,AP Enviro 313,AP Enviro 313,LW 1 CP Biology 313,LW 1 CP Biology 313,Honors Biology 313,Honors Biology 313
DeAntonis,,,Human Rights/Model UN 302,Human Rights/Model UN 302,LW 1 ECE US History 302,LW 1 ECE US History 302,AP/ECE US History 302,
Domini,Authors of Eye 202,Authors of Eye 202,English 9-H 202,English 9-H 202,LW 2 English 12-H 202,LW 2 English 12-H 202,Authors of Eye 202,Authors of Eye 202
Donnelly,English 11-1 100,English 11-1 100,English 10-H 100,English 10-H 100,LW 2 English 12-1 100,LW 2 English 12-1 100,English 12-H 100,English 12-H 100
Kaiser,AP/ECE Chemistry 314,AP/ECE Chemistry 314,,,LW 1 CP Chemistry 314,LW 1 CP Chemistry 314,CP Chemistry 314,CP Chemistry 314
Koltypin,Spanish 1 200,Spanish 1 200,Spanish 1 200,Spanish 1 200,,,Spanish 1 200,Spanish 1 200
MC,MC,MC,MC,MC,MC,MC,MC
Merturi,Accounting 1 310,Accounting 1 310,Yearbook 310,Accountin Honors 310,LW 1 Marketing in the 21st Century 310,LW 1 Marketing in the 21st Century 310,,
Morest,Social Studies 9-H 300,Social Studies 9-H 300,US Hist American People 300,US Hist American People 300,LW 1 Debate and Rhetoric 300,,,AP US Gov and Polit 300
Morse ,Civics 303,Civics 303,,,LW 1 African American/PR Studies 303,LW 1 African American/PR Studies 303,,
O'Connell,IM3 108,IM3 108,IM3 H 108,IM3 H 108,,,IM2 108,IM2 108
Open-Anselmo,Push In IM1/Lab 208,Push In IM1/Lab 208,,,LW 2 IED 104,,IED 217B,IED 217B
Open-Gomez,Spanish 2 302,Spanish 2 302,,,,,,
Palmer,,,Spanish 2 110,Spanish 2 110,LW 2 Spanish 2 110,LW 2 Spanish 2 110,Spanish 2 110,Spanish 2 110
Pendharkar,Push In Eng 9 203,Push In Eng 9 203,,IED 217B,LW 2 Math Apllications 111,LW 1 IED 104,,
Penn,Health 2 201,Health 2 201,Health 1 203,Health 1 203,LW 2 PE 9 306,LW 2 PE 9 300,,
Peterson,Intro to Comp Sci 311,Intro to Comp Sci 311,DE Honors 311,AP Comp Sci A 311,,,Intro to ED 311,Intro to ED 311
Pirri,,IED 217B,IED 217B,IED 104,Push In IM1/Lab 108,Push In IM1/Lab 108,,
Pollicella,,AP Psychology 103,,AP Psychology 103,LW 2 AP Psychology 103,,African American/PR Studies 103,African American/PR Studies 103
Priolo,,,,,LW 2 Social Studies 9-1 201,LW 2 Social Studies 9-1 201,,
Pusser,,,AP US Gov and Polit 301,AP Human Geography 301,LW 1 AP Human Geography 301,LW 1 AP Human Geography 301,Social Studies 9-1 301,Social Studies 9-1 301
Ray,PreCalc 107,PreCalc 107,,,LW 2 IM2 H 208,LW 2 IM2 H 208,PreCalc 209,PreCalc 209
Ridley,Conceptual Physics H 110,Conceptual Physics H 110,Capstone 210,PLTW Civil Engin & Arch 210,,,PLTW Civil Engin & Arch 210,PLTW Civil Engin & Arch 210
Russo,AP/ECE Biology 309,AP/ECE Biology 309,,,LW 1 AP/ECE Biology 309,LW 1 AP/ECE Biology 309,CP Biology 309/312,CP Biology 309/312
Scaturchio,,,Photography 1 204,Photography 1 204,LW 2 Digital Media 1 204,LW 2 Digital Media 1 204,Photography 1 204,Photography 1 204
Schell,,,AP PreCalc 208,AP PreCalc 208,,,,
Schott,,,Learning Lab 217A,Learning Lab 217A,LW 1 Learning Lab 217A,LW 1 Learning Lab 217A,,
Scollan,Chemistry Honors 313,Chemistry Honors 313,,,LW 1 Chemistry Honors 315,LW 1 Chemistry Honors 315,Chemistry Honors 312/309,Chemistry Honors 312/309
Semon,PE 9 306,Health 1 207,PE 10 103,Health 1 102,LW 2 PE 10 200,LW 2 PE 9 307,,
Serrano,IM1/Lab 208,IM1/Lab 208,,,LW 2 IM1/Lab 108,LW 2 IM1/Lab 108,IM1 H 208,IM1 H 208
Staff05,Honors Biology 307,Honors Biology 306 ,Marine 309,Marine 309,LW 1 Marine 107,LW 1 Marine 107,,
Stout,English 10-1 304,English 10-1 304,,AP/ECE English 10 304,LW 1 AP/ECE English 10 304,,AP/ECE English 10 304,
Tango,,,,,,,Tango/MC 206,Tango/MC 206
Tomaszewski,Robotics 211,Robotics 211,,,LW 1 Drawing and Painting 2 101,LW 1 Drawing and Painting 2 101,Drawing 101,Drawing 101
Urbanowski,IM2 209,IM2 209,IM1 H 209,IM1 H 209,,,Aerospace 206,Tango 
Vasquez,,,,,,,,
Walsh,Stress Management 102,Stress Management 102,FYS 102,,LW 1 Health 2 102,LW 1 Health 1 102,Intro to Healthcare Occupation 102,Intro to Healthcare Occupation 102
Weber,Forensics 315,Forensics 315,Capstone 211,Medical Interventions 315,,,Principles of Biomed PLTW 315,Principles of Biomed PLTW 315
Weisz,POE 210,POE 210,PreCalc 107,PreCalc 107,,,POE 211,POE 211
Wolff,,,,,LW 1 English 11-H 305,LW 1 English 11-H 305,English 9-H 305,English 9-H 305
Xiong,,AP/ECE Physics 312,Conceptual Physics 312,Conceptual Physics 312,LW 2 CP/H Physics 312,,Mandarin 2 201,Mandarin 2 201
Yang ,Physics CP/Honors 312(A),Physics CP/Honors 307(B),Mandarin 1 201,Mandarin 1 201,LW 1 Conceptual Physics Honors 307(A),LW 1 Conceptual Physics Honors 312(B),,
Yates,,,AP English 11 306,,,LW 2 AP English 11 306,,`;

        // Function to parse class and room from a string like "AP Calculus 207"
        function parseClassAndRoom(cell) {
            if (!cell || cell.trim() === '') {
                return { class: '', room: '' };
            }
            const trimmedCell = cell.trim();
            
            // Special case for "MC" and "Tango"
            if (trimmedCell.toLowerCase() === 'mc') {
                return { class: 'Media Center', room: 'MC' };
            }
            if (trimmedCell.toLowerCase() === 'tango') {
                return { class: 'Tango', room: '' };
            }
            if (trimmedCell.toLowerCase().includes('tango/mc')) {
                 return { class: 'Tango/Media Center', room: '206' };
            }
            
            // A special case for "LW" classes, as they sometimes have a class name that
            // is not at the end of the string.
            if (trimmedCell.startsWith("LW")) {
                const parts = trimmedCell.split(' ');
                const room = parts[parts.length - 1];
                const className = trimmedCell.substring(0, trimmedCell.lastIndexOf(' '));
                return { class: className, room: room };
            }
            // A special case for "Push In" classes
            if (trimmedCell.startsWith("Push In")) {
                const parts = trimmedCell.split(' ');
                const room = parts[parts.length - 1];
                const className = trimmedCell.substring(0, trimmedCell.lastIndexOf(' '));
                return { class: className, room: room };
            }

            // Use a more robust regex to find a room number at the end of the string.
            const match = trimmedCell.match(/\b(\d+[\w\/\(\)]*)\s*$/);
            if (match) {
                const room = match[1];
                const className = trimmedCell.substring(0, match.index).trim();
                return { class: className, room: room };
            }
            
            // If no room number is found, assume the whole string is the class name.
            return { class: trimmedCell, room: '' };
        }

        // Parse the CSV data
        const rows = csvContent.split('\n').map(row => row.split(',').map(cell => cell.trim()));
        const headers = rows[0];
        const dataRows = rows.slice(1);

        const teachers = [];
        const teacherSchedules = {};
        const substitutes = ["Brown", "Anderson", "Ostozewski", "James"];

        dataRows.forEach(row => {
            const teacherName = row[0];
            if (teacherName) {
                teachers.push(teacherName);
                const schedule = {
                    "A-Day": [],
                    "B-Day": []
                };

                for (let i = 1; i <= 4; i++) {
                    const aDayClass = parseClassAndRoom(row[i * 2 - 1] || '');
                    const bDayClass = parseClassAndRoom(row[i * 2] || '');

                    // Only add classes that have a class name
                    if (aDayClass.class && aDayClass.room) {
                         schedule["A-Day"].push({ period: i, class: aDayClass.class, room: aDayClass.room });
                    }
                    if (bDayClass.class && bDayClass.room) {
                         schedule["B-Day"].push({ period: i, class: bDayClass.class, room: bDayClass.room });
                    }
                }
                teacherSchedules[teacherName] = schedule;
            }
        });
        
        // A structured representation of the bell schedules, now including day types.
        const bellSchedules = {
            "Normal": {
                "A-Day": [
                    { period: "1", time: "7:25 â€“ 8:49", class: "", room: "" },
                    { period: "2", time: "8:54 â€“ 10:22", class: "", room: "" },
                    { period: "3 (1st Lunch Wave)", time: "10:27 â€“ 11:07 (Lunch) / 11:12 â€“ 12:36 (Class)", lunchTime: "10:27 - 11:07", class: "", room: "" },
                    { period: "3 (2nd Lunch Wave)", time: "10:27 â€“ 11:51 (Class) / 11:56 â€“ 12:36 (Lunch)", lunchTime: "11:56 - 12:36", class: "", room: "" },
                    { period: "4", time: "12:41 â€“ 2:05", class: "", room: "" }
                ],
                "B-Day": [
                    { period: "1", time: "7:25 â€“ 8:49", class: "", room: "" },
                    { period: "2", time: "8:54 â€“ 10:22", class: "", room: "" },
                    { period: "3 (1st Lunch Wave)", time: "10:27 â€“ 11:07 (Lunch) / 11:12 â€“ 12:36 (Class)", lunchTime: "10:27 - 11:07", class: "", room: "" },
                    { period: "3 (2nd Lunch Wave)", time: "10:27 â€“ 11:51 (Class) / 11:56 â€“ 12:36 (Lunch)", lunchTime: "11:56 - 12:36", class: "", room: "" },
                    { period: "4", time: "12:41 â€“ 2:05", class: "", room: "" }
                ]
            },
            "2-Hour Delay": {
                "A-Day": [
                    { period: "1", time: "9:25 â€“ 10:12", class: "", room: "" },
                    { period: "2", time: "10:17 â€“ 11:06", class: "", room: "" },
                    { period: "3 (1st Wave)", time: "1st Wave (Lunch: 11:11 â€“ 11:41) / (Class: 11:46 â€“ 12:33)", lunchTime: "11:11 - 11:41", class: "", room: "" },
                    { period: "3 (2nd Wave)", time: "2nd Wave (Class: 11:11 â€“ 11:58) / (Lunch: 12:03 â€“ 12:33)", lunchTime: "12:03 - 12:33", class: "", room: "" },
                    { period: "4", time: "12:38 â€“ 2:05", class: "", room: "" }
                ],
                "B-Day": [
                    { period: "1", time: "9:25 â€“ 10:12", class: "", room: "" },
                    { period: "2", time: "10:17 â€“ 11:06", class: "", room: "" },
                    { period: "3 (1st Wave)", time: "1st Wave (Lunch: 11:11 â€“ 11:41) / (Class: 11:46 â€“ 12:33)", lunchTime: "11:11 - 11:41", class: "", room: "" },
                    { period: "3 (2nd Wave)", time: "2nd Wave (Class: 11:11 â€“ 11:58) / (Lunch: 12:03 â€“ 12:33)", lunchTime: "12:03 - 12:33", class: "", room: "" },
                    { period: "4", time: "12:38 â€“ 2:05", class: "", room: "" }
                ]
            },
            "Half Day": {
                "A-Day": [
                    { period: "1", time: "7:25 â€“ 8:12", class: "", room: "" },
                    { period: "2", time: "8:17 â€“ 9:04", class: "", room: "" },
                    { period: "3", time: "9:09 â€“ 9:56", class: "", room: "" },
                    { period: "4", time: "10:01 â€“ 10:48", class: "", room: "" }
                ],
                "B-Day": [
                    { period: "1", time: "7:25 â€“ 8:12", class: "", room: "" },
                    { period: "2", time: "8:17 â€“ 9:04", class: "", room: "" },
                    { period: "3", time: "9:09 â€“ 9:56", class: "", room: "" },
                    { period: "4", time: "10:01 â€“ 10:48", class: "", room: "" }
                ]
            },
            "Connections": {
                "A-Day": [
                    { period: "1", time: "00:00 - 00:00", class: "", room: "" },
                    { period: "2", time: "00:00 - 00:00", class: "", room: "" },
                    { period: "3 (1st Lunch Wave)", time: "1st Wave (Lunch: 10:54 â€“ 11:25) / (Class: 11:25 â€“ 12:14)", lunchTime: "10:54 - 11:25", class: "", room: "" },
                    { period: "3 (2nd Lunch Wave)", time: "2nd Wave (Class: 10:54 â€“ 12:14) / (Lunch: 12:14 â€“ 12:45)", lunchTime: "12:14 - 12:45", class: "", room: "" },
                    { period: "4", time: "00:00 - 00:00", class: "", room: "" }
                ],
                "B-Day": [
                    { period: "1", time: "00:00 - 00:00", class: "", room: "" },
                    { period: "2", time: "00:00 - 00:00", class: "", room: "" },
                    { period: "3 (1st Lunch Wave)", time: "1st Wave (Lunch: 10:54 â€“ 11:25) / (Class: 11:25 â€“ 12:14)", lunchTime: "10:54 - 11:25", class: "", room: "" },
                    { period: "3 (2nd Lunch Wave)", time: "2nd Wave (Class: 10:54 â€“ 12:14) / (Lunch: 12:14 â€“ 12:45)", lunchTime: "12:14 - 12:45", class: "", room: "" },
                    { period: "4", time: "00:00 - 00:00", class: "", room: "" }
                ]
            }
        };


        // Get references to DOM elements
        const mainControls = document.getElementById('main-controls');
        const absentTeacherSelect = document.getElementById('absent-teacher-select');
        const dayTypeSelect = document.getElementById('day-type-select');
        const daySelect = document.getElementById('day-select');
        const getScheduleButton = document.getElementById('get-schedule-button');
        const combinedScheduleArea = document.getElementById('combined-schedule-area');
        const combinedScheduleTitle = document.getElementById('combined-schedule-title');
        const combinedScheduleBody = document.getElementById('combined-schedule-body');
        const noClassesMessage = document.getElementById('no-classes-combined-message');
        const uncoveredSummaryArea = document.getElementById('uncovered-summary-area');
        const uncoveredList = document.getElementById('uncovered-list');
        const allCoveredMessage = document.getElementById('all-covered-message');
        const exportButton = document.getElementById('export-button');
        const generateReportsButton = document.getElementById('generate-reports-button');
        const subReportsContainer = document.getElementById('sub-reports-container');

        // A data structure to hold the current combined schedule
        let combinedSchedule = [];
        // A data structure to hold assignments
        let assignments = {};

        // Populate the absent teacher dropdown with names from the data
        function populateAbsentTeachers() {
            teachers.forEach(teacherName => {
                const option = document.createElement('option');
                option.value = teacherName;
                option.textContent = teacherName;
                absentTeacherSelect.appendChild(option);
            });
        }

        // Enable/disable the button based on dropdown selections
        function updateButtonState() {
            const isTeacherSelected = absentTeacherSelect.selectedOptions.length > 0;
            const isDayTypeSelected = dayTypeSelect.value !== '';
            const isDaySelected = daySelect.value !== '';
            getScheduleButton.disabled = !(isTeacherSelected && isDayTypeSelected && isDaySelected);
        }

        // Handle button click to find and display the combined schedule
        function getCombinedSchedule() {
            const selectedTeachers = Array.from(absentTeacherSelect.selectedOptions).map(option => option.value);
            const selectedDay = daySelect.value;
            const selectedDayType = dayTypeSelect.value;

            // Hide messages
            noClassesMessage.classList.add('hidden');
            uncoveredSummaryArea.classList.add('hidden');
            allCoveredMessage.classList.add('hidden');

            combinedSchedule = [];
            assignments = {}; // Clear previous assignments

            // Aggregate schedules for all selected teachers
            selectedTeachers.forEach(teacherName => {
                const scheduleForDay = teacherSchedules[teacherName]?.[selectedDay] || [];
                scheduleForDay.forEach(classItem => {
                    // Only add classes that have a class name and room
                    if (classItem.class && classItem.room) {
                        combinedSchedule.push({
                            teacher: teacherName,
                            period: classItem.period,
                            class: classItem.class,
                            room: classItem.room,
                            id: `${teacherName}-${selectedDay}-${classItem.period}`,
                            status: 'Unassigned'
                        });
                    }
                });
            });

            // Sort the combined schedule by period
            combinedSchedule.sort((a, b) => a.period - b.period);

            renderCombinedSchedule();
        }

        // Renders the combined schedule and assignment tools
        function renderCombinedSchedule() {
            // Update the title
            const selectedTeachersText = Array.from(absentTeacherSelect.selectedOptions).map(option => option.value).join(', ');
            combinedScheduleTitle.textContent = `Combined Schedule for ${selectedTeachersText} on a ${dayTypeSelect.value} - ${daySelect.value}`;
            
            // Clear previous table content
            combinedScheduleBody.innerHTML = '';
            
            if (combinedSchedule.length > 0) {
                combinedSchedule.forEach(item => {
                    const statusText = assignments[item.id] ? `Assigned to ${assignments[item.id]}` : 'Unassigned';
                    const statusColor = assignments[item.id] ? 'text-green-600 font-semibold' : 'text-red-500';
                    
                    const tr = document.createElement('tr');
                    tr.classList.add('border-t', 'border-gray-200', 'hover:bg-gray-50', 'transition-colors');
                    tr.dataset.id = item.id;

                    let substituteOptions = substitutes.map(sub => `<option value="${sub}" ${assignments[item.id] === sub ? 'selected' : ''}>${sub}</option>`).join('');

                    tr.innerHTML = `
                        <td class="py-3 px-4">${item.teacher}</td>
                        <td class="py-3 px-4">${item.period}</td>
                        <td class="py-3 px-4">${item.class}</td>
                        <td class="py-3 px-4">${item.room}</td>
                        <td class="py-3 px-4 ${statusColor}">${statusText}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-center gap-2">
                                <select class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
                                    <option value="">-- Assign --</option>
                                    ${substituteOptions}
                                </select>
                            </div>
                        </td>
                    `;
                    combinedScheduleBody.appendChild(tr);

                    const selectElement = tr.querySelector('select');
                    selectElement.addEventListener('change', (e) => {
                        const selectedSub = e.target.value;
                        if (selectedSub) {
                            assignments[item.id] = selectedSub;
                        } else {
                            delete assignments[item.id];
                        }
                        renderCombinedSchedule();
                        updateUncoveredList();
                        updateGenerateReportsButtonState();
                    });
                });

                combinedScheduleArea.classList.remove('hidden');
                updateUncoveredList();
                updateGenerateReportsButtonState();
            } else {
                combinedScheduleArea.classList.remove('hidden');
                combinedScheduleBody.innerHTML = '';
                noClassesMessage.classList.remove('hidden');
                uncoveredSummaryArea.classList.add('hidden');
                generateReportsButton.classList.add('hidden');
            }
        }
        
        // Updates the list of uncovered classes
        function updateUncoveredList() {
            uncoveredList.innerHTML = '';
            const uncoveredClasses = combinedSchedule.filter(item => !assignments[item.id]);

            if (uncoveredClasses.length > 0) {
                uncoveredClasses.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.teacher}'s Period ${item.period} (${item.class}) is Unassigned.`;
                    uncoveredList.appendChild(li);
                });
                uncoveredSummaryArea.classList.remove('hidden');
                allCoveredMessage.classList.add('hidden');
            } else {
                uncoveredSummaryArea.classList.remove('hidden');
                allCoveredMessage.classList.remove('hidden');
            }
        }
        
        // Enables/disables the Generate Reports button based on if any assignments exist
        function updateGenerateReportsButtonState() {
            const hasAssignments = Object.keys(assignments).length > 0;
            if (hasAssignments) {
                generateReportsButton.classList.remove('hidden');
            } else {
                generateReportsButton.classList.add('hidden');
            }
        }

        // Generate and display individual substitute reports
        function generateSubReports() {
            // Group assignments by substitute
            const subAssignments = {};
            for (const id in assignments) {
                const subName = assignments[id];
                const assignmentDetails = combinedSchedule.find(item => item.id === id);
                if (!subAssignments[subName]) {
                    subAssignments[subName] = [];
                }
                subAssignments[subName].push(assignmentDetails);
            }
            
            // Clear previous reports and buttons
            subReportsContainer.innerHTML = '';
            
            const day = daySelect.value;
            const dayType = dayTypeSelect.value;

            // Generate a report for each substitute with assignments
            for (const subName in subAssignments) {
                // Get the base bell schedule for the day type. This will have blank class/room fields.
                const tempBellSchedule = JSON.parse(JSON.stringify(bellSchedules[dayType][day]));
                
                const assignmentsForSub = subAssignments[subName].sort((a, b) => a.period - b.period);
                
                // Determine the lunch time for the substitute
                let lunchTime = 'Not specified in schedule.';
                if (dayType === 'Normal' || dayType === 'Connections' || dayType === '2-Hour Delay') {
                    const assignedLunch = assignmentsForSub.find(a => a.class.includes("LW") || a.class.includes("Wave"));
                    if (assignedLunch) {
                        const lunchWave = assignedLunch.class.includes("LW 1") || assignedLunch.class.includes("1st Wave") ? "1st Lunch Wave" : "2nd Lunch Wave";
                        const lunchPeriod = bellSchedules[dayType][day].find(item => item.period.includes(lunchWave));
                        if (lunchPeriod) {
                             lunchTime = lunchPeriod.lunchTime;
                        }
                    } else {
                         lunchTime = 'Your lunch time is not explicitly defined.';
                    }
                } else if (dayType === 'Half Day') {
                    // Half days have no lunch period
                    lunchTime = 'No lunch period on a half day.';
                }

                // Populate the temporary bell schedule with assigned classes
                assignmentsForSub.forEach(assignment => {
                    const periodItem = tempBellSchedule.find(item => {
                        // Special handling for Period 3 (Lunch Waves)
                        if (assignment.period === 3 && (dayType === 'Normal' || dayType === '2-Hour Delay' || dayType === 'Connections')) {
                            const isLW1 = assignment.class.includes("LW 1") || assignment.class.includes("1st Wave");
                            const isLW2 = assignment.class.includes("LW 2") || assignment.class.includes("2nd Wave");
                            return (isLW1 && (item.period.includes("1st Lunch Wave") || item.period.includes("1st Wave"))) || 
                                   (isLW2 && (item.period.includes("2nd Lunch Wave") || item.period.includes("2nd Wave")));
                        }
                        // For other periods, match by period number
                        return item.period.startsWith(String(assignment.period));
                    });

                    if (periodItem) {
                        // Extract class name from string like "LW 1 AP Calculus"
                        const className = assignment.class.replace(/LW \d+/, '').replace(/\d+st Wave/, '').replace(/\d+nd Wave/, '').trim();
                        periodItem.class = `${assignment.teacher}'s Class: ${className}`;
                        periodItem.room = assignment.room;
                    }
                });

                const reportDiv = document.createElement('div');
                reportDiv.classList.add('sub-report-container', 'bg-white', 'p-6', 'rounded-lg', 'shadow-md', 'border-b-4', 'border-gray-300', 'mb-6');
                reportDiv.innerHTML = `
                    <div class="p-6">
                        <h1 class="text-2xl font-bold text-center text-gray-800 mb-1">ACADEMY OF INFORMATION TECHNOLOGY & ENGINEERING</h1>
                        <h2 class="text-xl font-semibold text-center text-gray-700 mb-1">Bell Schedule 2025 - 2026</h2>
                        <h3 class="text-lg font-semibold text-center text-gray-700 mb-4">Substitute Report for ${subName} - ${dayType} ${day}</h3>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full bg-white rounded-lg shadow-md border border-gray-200">
                                <thead class="bg-gray-200 text-gray-700">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold">Period</th>
                                        <th class="py-3 px-4 text-left font-semibold">Time</th>
                                        <th class="py-3 px-4 text-left font-semibold">Class</th>
                                        <th class="py-3 px-4 text-left font-semibold">Room</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-600">
                                    ${tempBellSchedule.map(item => `
                                        <tr class="border-t border-gray-200">
                                            <td class="py-3 px-4">${item.period}</td>
                                            <td class="py-3 px-4">${item.time}</td>
                                            <td class="py-3 px-4">${item.class}</td>
                                            <td class="py-3 px-4">${item.room}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <p class="text-gray-700 mt-4 font-semibold">Your lunch time is: ${lunchTime}</p>
                        <p class="text-gray-500 mt-2">Please return the bathroom key.</p>
                        <p class="text-gray-500">Thank you for your assistance today.</p>
                    </div>
                `;
                subReportsContainer.appendChild(reportDiv);
            }
            
            // Add the buttons to the subReportsContainer after generating the reports
            const buttonContainer = document.createElement('div');
            buttonContainer.classList.add('flex', 'flex-col', 'md:flex-row', 'justify-center', 'items-center', 'gap-4', 'mt-6', 'mb-8', 'no-print');
            buttonContainer.innerHTML = `
                <button id="print-reports-button" class="w-full md:w-1/2 p-3 text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors duration-300 font-semibold shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Print Reports
                </button>
                <button id="back-button" class="w-full md:w-1/2 p-3 text-white bg-gray-600 rounded-lg hover:bg-gray-700 transition-colors duration-300 font-semibold shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                    Back to Manager
                </button>
            `;
            subReportsContainer.appendChild(buttonContainer);

            // Re-attach event listeners to the new buttons
            const newPrintButton = document.getElementById('print-reports-button');
            const newBackButton = document.getElementById('back-button');
            newPrintButton.addEventListener('click', () => window.print());
            newBackButton.addEventListener('click', goBack);

            // Show the reports and hide the main controls
            mainControls.classList.add('hidden');
            subReportsContainer.classList.remove('hidden');
        }

        // Export data to CSV
        function exportToCsv() {
            const selectedDay = daySelect.value;
            const selectedDayType = dayTypeSelect.value;
            
            let csvContent = "data:text/csv;charset=utf-8,Teacher,Period,Class,Room,Assigned Substitute\n";
            
            combinedSchedule.forEach(item => {
                const assignedSub = assignments[item.id] || "N/A";
                const row = [
                    `"${item.teacher}"`,
                    `"${item.period}"`,
                    `"${item.class}"`,
                    `"${item.room}"`,
                    `"${assignedSub}"`
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `sub_schedule_${selectedDayType}_${selectedDay}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Go back to the main management screen
        function goBack() {
            subReportsContainer.classList.add('hidden');
            mainControls.classList.remove('hidden');
        }

        // Event listeners
        absentTeacherSelect.addEventListener('change', updateButtonState);
        dayTypeSelect.addEventListener('change', updateButtonState);
        daySelect.addEventListener('change', updateButtonState);
        getScheduleButton.addEventListener('click', getCombinedSchedule);
        exportButton.addEventListener('click', exportToCsv);
        generateReportsButton.addEventListener('click', generateSubReports);
        
        // Initial setup
        populateAbsentTeachers();
        updateButtonState(); // Set initial button state
    </script>
</body>
</html>


